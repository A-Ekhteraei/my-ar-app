<!DOCTYPE html>
<html>
<head>
    <title>Stable Marker Test</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
        .debug {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.8); color: white;
            padding: 15px; font-family: monospace;
            border-radius: 5px; z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="debug">
        <strong>Marker Stability Test</strong><br>
        Status: <span id="status">Initializing...</span><br>
        Found: <span id="found">0</span> times<br>
        Lost: <span id="lost">0</span> times<br>
        <button onclick="location.reload()">Reset Counter</button>
    </div>
    
    <!-- OPTIMIZED AR SCENE -->
    <a-scene 
        embedded 
        arjs="sourceType: webcam; 
              detectionMode: mono;
              trackingMethod: best;
              debugUIEnabled: true;  <!-- Turn on to see detection -->
              maxDetectionRate: 60;
              canvasWidth: 640;
              canvasHeight: 480;">
        
        <!-- STABILIZED MARKER SETTINGS -->
        <a-marker 
            id="stabilizedMarker"
            type="pattern" 
            url="markers/my-marker.patt"
            
            <!-- STABILIZATION SETTINGS -->
            smooth="true"
            smoothCount="15"
            smoothTolerance="0.01"
            smoothThreshold="5"
            
            <!-- PERFORMANCE SETTINGS -->
            emitevents="true"
            size="200"
            preset="custom"
            
            <!-- For debugging -->
            debug="true">
            
            <!-- Test object -->
            <a-box 
                id="testCube"
                position="0 0.5 0" 
                color="green"
                width="1" height="1" depth="1"
                metalness="0.5"
                roughness="0.5">
            </a-box>
            
            <!-- Add platform for better visual -->
            <a-cylinder 
                position="0 -0.5 0" 
                radius="0.8" 
                height="0.05" 
                color="#444"
                metalness="0.3"
                roughness="0.7">
            </a-cylinder>
            
        </a-marker>
        
        <!-- CAMERA with better settings -->
        <a-entity camera="fov: 60; near: 0.01; far: 100;"></a-entity>
        
        <!-- Add lighting for better visibility -->
        <a-entity light="type: ambient; color: #888; intensity: 0.9"></a-entity>
        <a-entity light="type: directional; color: #FFF; intensity: 0.8" position="1 3 2"></a-entity>
        
    </a-scene>
    
    <script>
        console.log("=== STABILITY TEST STARTED ===");
        
        let foundCount = 0;
        let lostCount = 0;
        let lastFoundTime = 0;
        
        const marker = document.getElementById('stabilizedMarker');
        const cube = document.getElementById('testCube');
        
        // Track stability
        marker.addEventListener('markerFound', () => {
            foundCount++;
            lastFoundTime = Date.now();
            
            document.getElementById('status').textContent = 'STABLE';
            document.getElementById('status').style.color = 'lime';
            document.getElementById('found').textContent = foundCount;
            
            console.log(`Marker found #${foundCount}`);
            
            // Visual feedback - pulse green when found
            cube.setAttribute('animation', {
                property: 'material.color',
                type: 'color',
                from: '#00FF00',
                to: '#008800',
                dur: 500,
                easing: 'easeOutQuad'
            });
        });
        
        marker.addEventListener('markerLost', () => {
            lostCount++;
            
            const timeSinceFound = Date.now() - lastFoundTime;
            document.getElementById('status').textContent = `LOST (was stable for ${timeSinceFound}ms)`;
            document.getElementById('status').style.color = 'red';
            document.getElementById('lost').textContent = lostCount;
            
            console.log(`Marker lost #${lostCount}. Was stable for ${timeSinceFound}ms`);
            
            // Visual feedback - flash red when lost
            cube.setAttribute('material', 'color', 'red');
            setTimeout(() => {
                if (!marker.object3D.visible) {
                    cube.setAttribute('material', 'color', 'green');
                }
            }, 200);
        });
        
        // Monitor marker position for jitter
        let lastPos = null;
        let jitterCount = 0;
        
        marker.addEventListener('componentchanged', (event) => {
            if (event.detail.name === 'position') {
                const currentPos = marker.getAttribute('position');
                
                if (lastPos) {
                    const distance = Math.sqrt(
                        Math.pow(currentPos.x - lastPos.x, 2) +
                        Math.pow(currentPos.y - lastPos.y, 2) +
                        Math.pow(currentPos.z - lastPos.z, 2)
                    );
                    
                    // If position jumps too much, it's jitter
                    if (distance > 0.1) {
                        jitterCount++;
                        console.warn(`Jitter detected #${jitterCount}: ${distance.toFixed(3)}`);
                    }
                }
                lastPos = {...currentPos};
            }
        });
        
        // Scene loaded
        document.querySelector('a-scene').addEventListener('loaded', () => {
            document.getElementById('status').textContent = 'Ready - Point at marker';
            document.getElementById('status').style.color = 'yellow';
            console.log("Scene loaded with stabilization");
        });
    </script>
</body>
</html>
